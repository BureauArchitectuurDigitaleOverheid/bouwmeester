apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: bouwmeester

resources:
  - ../../base

patches:
  # Backend: 3 replicas, higher resources
  - target:
      kind: Deployment
      name: bouwmeester-backend
    patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: bouwmeester-backend
      spec:
        replicas: 3
        template:
          spec:
            containers:
              - name: bouwmeester-backend
                resources:
                  requests:
                    memory: "512Mi"
                    cpu: "250m"
                  limits:
                    memory: "1Gi"
                    cpu: "1000m"

  # Frontend: 3 replicas, higher resources
  - target:
      kind: Deployment
      name: bouwmeester-frontend
    patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: bouwmeester-frontend
      spec:
        replicas: 3
        template:
          spec:
            containers:
              - name: bouwmeester-frontend
                resources:
                  requests:
                    memory: "128Mi"
                    cpu: "100m"
                  limits:
                    memory: "256Mi"
                    cpu: "500m"

  # Production ingress host (same as base, explicit for clarity)
  - target:
      kind: Ingress
      name: bouwmeester-ingress
    patch: |
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: bouwmeester-ingress
      spec:
        tls:
          - hosts:
              - bouwmeester.rijkscloud.nl
            secretName: bouwmeester-tls
        rules:
          - host: bouwmeester.rijkscloud.nl
            http:
              paths:
                - path: /api
                  pathType: Prefix
                  backend:
                    service:
                      name: bouwmeester-backend
                      port:
                        number: 8080
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: bouwmeester-frontend
                      port:
                        number: 80

  # Production ConfigMap values
  - target:
      kind: ConfigMap
      name: bouwmeester-config
    patch: |
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: bouwmeester-config
      data:
        APP_NAME: "Bouwmeester"
        DEBUG: "false"
        DATABASE_URL: "postgresql+asyncpg://bouwmeester:bouwmeester@postgres:5432/bouwmeester"
        OIDC_ISSUER: "https://login.rijkscloud.nl/realms/bouwmeester"
        OIDC_CLIENT_ID: "bouwmeester"
