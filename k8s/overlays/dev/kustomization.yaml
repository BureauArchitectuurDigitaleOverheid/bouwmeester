apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: bouwmeester

resources:
  - ../../base

patches:
  # Backend: 1 replica, lower resources
  - target:
      kind: Deployment
      name: bouwmeester-backend
    patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: bouwmeester-backend
      spec:
        replicas: 1
        template:
          spec:
            containers:
              - name: bouwmeester-backend
                resources:
                  requests:
                    memory: "128Mi"
                    cpu: "50m"
                  limits:
                    memory: "256Mi"
                    cpu: "250m"

  # Frontend: 1 replica
  - target:
      kind: Deployment
      name: bouwmeester-frontend
    patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: bouwmeester-frontend
      spec:
        replicas: 1

  # Dev ingress host
  - target:
      kind: Ingress
      name: bouwmeester-ingress
    patch: |
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: bouwmeester-ingress
      spec:
        tls:
          - hosts:
              - bouwmeester-dev.rijkscloud.nl
            secretName: bouwmeester-dev-tls
        rules:
          - host: bouwmeester-dev.rijkscloud.nl
            http:
              paths:
                - path: /api
                  pathType: Prefix
                  backend:
                    service:
                      name: bouwmeester-backend
                      port:
                        number: 8080
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: bouwmeester-frontend
                      port:
                        number: 80

  # Dev ConfigMap values
  - target:
      kind: ConfigMap
      name: bouwmeester-config
    patch: |
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: bouwmeester-config
      data:
        APP_NAME: "Bouwmeester (Dev)"
        DEBUG: "true"
        DATABASE_URL: "postgresql+asyncpg://bouwmeester:bouwmeester@postgres:5432/bouwmeester_dev"
        OIDC_ISSUER: "https://login-dev.rijkscloud.nl/realms/bouwmeester"
        OIDC_CLIENT_ID: "bouwmeester-dev"
